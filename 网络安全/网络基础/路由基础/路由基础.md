# 路由基础

***

# 路由原理

### 路由器

-   路由：将一个数据报文从一个子网转发到另一个子网
-   路由器：Router，执行路由行为的机器
-   路由表：在路由器中存储的用于路由的各种传输路径的数据

### 路由器功能

-   检查数据包的目的地
-   发现可能的路由信息
-   选择最佳路径
-   验证和维护路由信息
-   隔离广播包，防止网络广播风暴

### 直连设备特征

-   路由器上所有直连设备在不同冲突域之中
-   路由器上所有智联设备在不同广播域之中
-   路由器各接口上所有直连设备独享接口带宽

### 路由表查找规则

-   最长匹配（按匹配的IP长度最长的转发）
-   迭代查找（ 下一跳地址在路由表中有记录则使用这个地址的下一跳进行转发 ）
-   默认路由转发（ 若在路由表中匹配不到转发地址则使用默认路由地址0.0.0.0进行下一跳转发 ），既缺省路由

### 路由优先级

到相同的目的地址有多个路由

-   以Preference（优先级）确定不同类型的优先级
-   Preference值越小，优先级越高
-   优先级最高的路由被添加进理由表

# 路由协议

### 路由协议与可路由协议

-   路由协议

    路由器用来计算、维护路由信息的协议、算法，工作在网络层或应用层（ OSPF、RIP、BGP ）
-   可路由协议

    可被路由器转发的协议，工作在网络层（ IP协议、IPX协议 ）

### 路由协议的基本原理

-   网络中所有路由器必须使用相同的路由协议
-   邻居发现：路由器发送广播、组播、单播报文给指定的路由器邻居，主动介绍自己给网段内的其它路由器
-   交换路由：每台路由器将自己已知的路由信息发送给相邻路由器
-   计算路由：通过某种算法，计算最终路由
-   维护路由：路由器直接周期性发送协议报文来维护邻居信息

### 静态路由配置命令

在思科模拟器中

-   添加：ip route 	目的地址或网段	子网掩码	下一跳地址
-   查看：show ip route

### 路由环路

#### 环路产生

当路由表的某一个链路发生故障，路由表将该路由删除，但是更新周期到来时，邻居将原发生故障的链路更新给路由器，这时跳数增加，引起环路

#### 网络不可达

当环路产生，会因此跳数不断增加，定义当跳数为16时，则认为该路由不可达

#### 解除环路

-   水平分割（split horizon）：对于从一个接口收到的路由，不会再从这个接口发回去
-   路由抑制：从某个接口学到路由后，将该路由的度量值设置为无限大（16），并从原接口发回邻居路由器
-   抑制时间：当一条路由的度量变为无穷大，该路由进入抑制状态，只有来自同一邻居且度量小于16的路由更新才会被接收
-   触发更新：不等更新周期到来，路由器马上发送路由给相邻路由器

# RIP协议

### RIP协议概述

-   RIP（ routing information protocol ），路由信息协议
-   基于距离矢量算法
-   适用于中小型网络
-   支持水平分割、毒性逆转、和触发更新等工作机制
-   基于UDP传输，端口号520

### 更新原则

-   对已有的路由，邻居相同时，新的替换旧的
-   对已有的路由，邻居不同时，近的替代远的
-   对没有的路由，度量值小于16时，增加

### 3个定时器

-   update：发送路由更新的间隔，30秒
-   timeout：老化时间，如果路由在老化时间内没更新保卫，则设置度量值为16，并从路由表中撤销，180秒
-   garbage-collect：定义从度量值16开始，直到它被删除所经历的时间，120秒

### RIPv1的缺点：

-   发送协议报文时不携带掩码
-   不支持认证
-   只能以广播方式发送协议报文

### RIPv2的改进

-   是一种无类别路由协议
-   携带掩码信息，支持VLSM（可变长子网掩码）、CIDR
-   支持以组播方式（224.0.0.9）发送更新报文
-   支持验证，提供明文验证和MD5验证两种方式

### RIP的缺陷

-   以跳数评估路由并非最优路径（还要考虑带宽）
-   最大跳数16导致网络尺度小
-   收敛速度慢（当路由不可达时，还要进入抑制时间）
-   更新时发送全部路由表，浪费资源

# OSPF 协议

### OSPF概述

-   Open Shortest Path First，开放最短路径优先
-   基于链路状态的内部网关协议
-   仅传播对端设备不具备的路由信息，网络收敛迅速
-   工作在网络层上基于IP协议，端口号89
-   以组播地址发送协议包
-   支持多路负载均衡

### OSPF术语

-   链路：路由器用来连接网络的接口
-   链路状态：描述路由器接口及其邻居路由器的关系，所有链路状态信息构成链路状态数据库
-   区域：在同一个区域内的路由器有相同的链路状态数据库
-   自治系统：采用同一种路由协议交换路由信息的路由器及其网络构成的一个系统
-   链路状态通告（LSA）：LSA描述路由器的本地状态，包括路由器接口的状态和所形成的邻接状态
-   最短路径优先算法（SPF）：OSPF路由协议的基础，也成为Dijkstra算法
-   Router ID：在自治系统中唯一标识一台路由器的32位整数

### 划分区域

-   骨干区域：在一个AS（自治系统）中有且只有一个区域0，并且所有区域的通信都必须通过该区域
-   非骨干区域：非骨干区域之间不能直接交换数据包，必须与骨干区域相连
-   针对接口划分区域

### OSPF路由器分类

-   骨干路由器 BR ：至少有一个接口与骨干区域相连的路由器
-   边界路由器 ABR ：连接一个或多个区域到骨干区域的路由器，因此ABR也可能属于BR
-   内部路由器 IR ：所有接口都属于一个区域的路由器
-   自治系统边界路由器 ASBR ：与其它自治系统相连的路由器

### OSPF工作过程

-   寻找邻居
-   建立邻接关系
-   链路状态信息传递
-   计算路由

### OSPF优势

-   所有路由器对整个网络的拓扑有相同的认识，在此基础上计算的路由不可能 产生环路。
-   网络结构变化，收敛速度快。
-   每台路由器都有自己的 Router ID 号，能够很好地被跟踪。
-   SPF 算法计算路由，路由选择与网络能力直接联系，更合理。
-   采用多种手段保证信息传递的可靠性，同时避免了不必要的网络资源浪费

### 配置OSPF

#### 在思科模拟器中

```纯文本
router ospf process-id
network address wildcard-mask area area-id 
```

#### 例子

```纯文本
router ospf 100
network 10.1.1.2 0.0.0.0 area 0
```

#### 检验配置

```纯文本
show ip route
show ip ospf
show ip ospf ethernet 0/0
show ip ospf neighbor
```

#### 配置明文口令身份验证

```纯文本
ip address 192.168.1.101  255.255.255.254
ip ospf authentication
ip ospf authentication-key plainpas
```
