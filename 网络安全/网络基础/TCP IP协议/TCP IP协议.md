# TCP IP协议

## IP数据报格式

***

#### 固定部分（20字节）

-   版本（ 4bit ）：IP协议的版本，IPv4或者IPv6
-   首部长度（ 4bit ）：最大值为15个单位，一个单位为4字节，因为固定部分为20字节，所以首部长度最小值为5个单位，最大为60字节
-   服务类型（ 8bit ）：用来获得更好的服务，只有在使用区分服务时，这个字段才起作用，一般情况下不使用
-   总长度（ 16bit ）：首部和数据的总长度，单位为字节，因此数据报的最大长度为65535字节
-   标识（ 16bit ）：一个计数器，每产生一个数据报，计数器就加 1，当数据报的长度超过网络的 MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。具有相同的标识字段值的分片报文会被重组成原来的数据报。
-   标志（ 3bit ）：第一位未使用，其值为 0。第二位称为 DF（不分片），表示是否允许分片。取值为 0 时，表示允许分片；取值为 1 时，表示不允许分片。第三位称为 MF（更多分片），表示是否还有分片正在传输，设置为 0 时，表示没有更多分片需要发送，或数据报没有分片。
-   片偏移（ 13bit ）：报文分片后，该字段表示为该分片在报文中的相对位置，一个单位为8个字节
-   生存时间（ 8bit ）：TTL，最初单位是秒，现在用为表示跳数，数据报每经过一个路由器TTL值减1，因此最大跳数为255
-   协议（ 8bit ）：记录上一层使用的什么协议
-   首部检验和（ 16bit ）： 只检验数据报首部 ，将ip报头按16位为单位，不满则补0，进行反码求和运算，高位溢出加到最低位
-   源地址（ 32bit ）
-   目的地址 （ 32bit ）

#### 可变部分

#### 数据部分

## IP地址

***

#### IP地址分类

-   A类地址：1.0.0.0\~126.255.255.255
-   B类地址：128.0.0.0\~191.255.255.255
-   C类地址：192.0.0.0\~223.255.255.255
-   D类地址：224.0.0.0\~239.255.255.255（ 组播地址 ）
-   E类地址：240.0.0.0\~255.255.255.255 （ 保留 ）
-   127.x.x.x保留用于环回测试

#### IP地址范围

| 类型 | 标志    | 网络位（ network ） | 主机位（ host ） | 主机数      | 第一组8位二进制                   |
| -- | ----- | -------------- | ----------- | -------- | -------------------------- |
| A  | 0     | 7bit           | 24bit       | 16777214 | **0**0000000\~**0**1111110 |
| B  | 10    | 14bit          | 16bit       | 65534    | **10**000000\~**10**111111 |
| C  | 110   | 21bit          | 8bit        | 254      | **110**00000\~**110**11111 |
| D  | 1110  | -              | -           | -        | -                          |
| E  | 11110 | -              | -           | -        | -                          |

#### 特殊地址

| 地址           | 类型   | 作用        |
| ------------ | ---- | --------- |
| 网络any，主机全"0" | 网络地址 | 表示一个网段    |
| 网络any，主机全"1" | 广播地址 | 特定网段的所有节点 |
| 网络127，主机any  | 环回地址 | 环回测试      |
| 网络、主机全"0"    | 所用网络 | 指定默认路由    |
| 网络、主机全"1"    | 广播地址 | 本网段所有节点   |

#### 公用IP地址

| 类型 | 共有地址范围                                                           |
| -- | ---------------------------------------------------------------- |
| A  | 1.0.0.0\~9.255.255.255                 11.0.0.0\~126.255.255.255 |
| B  | 128.0.0.0\~172.15.255.255           172.32.0.0\~191.255.255.255  |
| C  | 192.0.0.0\~192.167.255.255         192.169.0.0\~223.255.255      |

#### 私有IP地址

| 类型 | 私有地址范围                       |
| -- | ---------------------------- |
| A  | 10.0.0.0\~10.255.255.255     |
| B  | 172.16.0.0\~172.31.255.255   |
| C  | 192.168.0.0\~192.168.255.255 |

## 子网

***

> 🔘 注：子网划分时要保留主机号全"0"作为网络地址，保留主机号全"1"为广播地址

#### 子网划分作用

-   小型网络更易于管理
-   总流量减少
-   易于应用网络安全策略

#### 子网掩码作用

-   用于划分网络部分和主机部分

#### 默认子网掩码

| 类型 | 子网掩码          |
| -- | ------------- |
| A  | 255.0.0.0     |
| B  | 255.255.0.0   |
| C  | 255.255.255.0 |

## 地址解析

***

#### ARP协议

地址解析协议，通过IP地址，发送广播到局域网上所有主机，获得目标的MAC地址

#### ARP协议过程

-   A主机需要发送数据给B主机，缓存中没有B主机的MAC地址
-   A主机发送带有自己的IP地址、MAC地址和B主机IP地址的ARP广播
-   所有主机都接到A主机的ARP广播，但只有B主机给A主机一个单播回复，并缓存A主机的IP与MAC地址
-   A主机缓存B主机的IP地址与MAC地址，并开始发送数据

#### ARP缓存的查询

-   在Windows系统中的命令：arp -a
-   在Linux系统中的命令：arp

#### ARP欺骗攻击

ARP攻击主要目的是使网络无法正常通信或通过转发流量进行控制和查看

#### 攻击类型与原理

1.  仿冒网关攻击

    主机A仿冒网关向主机B发送伪造的网关ARP报文，导致主机B的ARP表中记录错误的网关地址映射关系，使得正常的数据不能被网关接收
2.  欺骗网关攻击

    主机A仿冒主机B向网关发送伪造的ARP报文，导致网关的ARP表记录错的主机B地址映射关系，使得正常的数据报文不能被主机B接收
3.  欺骗终端用户

    主机A仿冒主机B向主机C发送伪造的ARP报文，导致主机C的ARP表记录错的主机B地址映射关系，使得正常的数据报文不能被主机B接收
4.  MAC洪泛攻击

    发送大量伪MAC地址数据帧给交换机，当交换机的地址表溢出时，会把单播帧变成广播帧，使得恶意获得数据

#### RARP协议

反向地址转换协议，主机发送一个自己的MAC地址广播，RARP服务器收到后返回对应的IP地址，功能有点类似DHCP，但是RARP只有查询没有动态分配

#### 代理ARP协议

网关收到源主机的ARP请求会使用自己的MAC地址与目的主机进行应答

#### 无故ARP协议

以自己的IP地址作为目的地址发送ARP请求

#### 无故ARP作用

-   检查重复地址
-   更新ARP缓存，当一个设备收到一个ARP请求时，发现缓存中已有源IP地址，则更新该IP地址对应的MAC地址

## ICMP协议

***

#### ICMP协议作用

Internet控制报文协议，用于检测网络通不通、主机是否可达、路由是否可用等

#### ICMP协议的信息类型

-   目的地不可达
-   TTL超时
-   信息请求
-   信息应答
-   地址请求
-   地址应答

#### ICMP的应用

-   ping

    ​一个主机发送一个ICMP请求报文，如果没有异常则返回ICMP响应报文，说明目的主机存在，当发生异常时候，则给主机返回一个错误信息封包，利用ICMP的请求与应答检测网络的连通性
-   tracert

    ​用于查看IP数据报从一台主机到另一台主机所经过的路由，利用到ICMP报文、IP首部（ 获取IP地址 ）和TTL字段（ 生命周期，防止永久循环 ），通过TTL超时机制检测网络连通性

# 传输层

***

传输层协议协议

|    | 可靠性          | 尽力      |
| -- | ------------ | ------- |
| 类型 | 面向连接         | 无连接     |
| 协议 | TCP          | UDP     |
| 排序 | 是            | 否       |
| 应用 | 电子邮件、文件共享、下载 | 语音流、视频流 |

## TCP

#### TCP的特点

-   TCP/IP协议栈的传输层
-   为应用程序访问的网络层
-   面向连接的协议
-   全双工模式运行
-   错误检查
-   数据报序列化
-   接受确认
-   数据恢复功能
-   流量控制

#### TCP数据报格式

#### 固定首部（20字节）

-   源端口（ 16bit ）
-   目的端口 （ 16bit ）
-   序号 （ 32bit ）：TCP连接的数据流中每个字节都编上一个序号seq（按顺序），序号范围为\[0,2^32-1]，整到到上限时回到0，该字段指的是本报文所发送的数据的第一个字节的序号
-   确认号（32bit）：期望下一个报文的序号字段
-   数据偏移（ 4bit ）：表示报文段的数据起始距离TCP报文段的起始有多远，既TCP报文的首部长度，一个单位为4个字节
-   保留（ 6bit ）：保留为今后使用
-   URG紧急比特（ 1bit ）：当URG为1时，表明紧急指针字段有效，表示报文中有紧急数据，应尽快传送，相当于高优先级的数据，例如Ctrl+C中断命令
-   ACK确认比特（ 1bit ）：当ACK为1时，表明确认号字段有效，TCP规定，在连接建立后所有的报文段都要把ACK置1
-   PSH推送比特（ 1bit ）：接收端收到PSH置1的报文段，就尽快的交付给接收应用进程，而不再等缓存填满再向上交付
-   RST复位比特（ 1bit ）：当RST为1时，表明TCP连接出现严重差错（如主机崩溃等），必须释放连接，然后重新建立连接，还可以用于拒绝一个非法的报文段或连接
-   SYN同步比特（ 1bit ）：当SYN为1且ACK=0时，表明这是一个连接请求报文，当SYN为1且ACK=1时，表明这是一个连接接受报文
-   FIN终止比特（ 1bit ）：当FIN为1时，表明此报文段的发送端数端已发送完毕，并要求释放传输连接
-   窗口（8bit）：作为发送方的发送窗口大小的依据，控制发送方发送的数据量，窗口值通常是动态变化的
-   校验和（2bit）：计算校验和包括首部和数据两个部分，并且要在报文段前加上12字节的伪首部（ 4个字节为源IP信息，4个字节为目的IP信息，1个字节为保留位，1个字节为协议号（6表示TCP，17表示UDP），2个字节为TCP长度 ），以16位为单位进行反码求和运算，高位溢出加到最低位
-   紧急指针（ 16bit ）：指出紧急数据的最后一个字节的序号，即使窗口值为0，都能发送紧急数据

#### 可变部分

#### 数据部分

#### TCP连接采用C/S方式

-   主动发起连接的应用进程叫做客户（ client ）
-   被动等待连接建立的应用进程叫做服务器（ server ）

#### 三次握手

#### 三次握手过程

1.  A —> B：SYN同步比特=1，seq序号=x
2.  B —> A：SYN同步比特=1，ACK确认比特=1，seq序号为=y，ack确认号=x+1；
3.  A —> B：ACK确认比特=1，seq序号=x+1,ack确认号=y+1

#### 为什么要用三次握手？

假设一种情况，不用三次握手，A请求连接B，请求信息由于某种原因停滞了未能发到B，A收不到确认，于是再发送一次请求连接，这次B受到请求并确认请求，连接建立开始传输，传输结束，这时第一条请求信息发送到了B端，B收到请求，于是再一起确认连接，这次A不会再理会B的确认，而B一直在等待A的传输，因此浪费很多资源

#### 四次挥手

> 🔘注：FIN=1只是表示这端不再继续发送数据（不包括确认）；当TCP连接使用Ctrl+C终止时，TCP连接会正常关闭；当TCP连接发送物理上的意外情况时（例如断开网线），windows会在一段时间后返回错误信息，而linux上仍认为TCP连接有效

#### 四次挥手过程

1.  A —> B：FIN终止比特=1（ 客户端数据发送完毕请求断开此方向传输 ），seq序号=x
2.  B —> A：ACK确认比特=1，seq序号=y，ack确认号=x+1
3.  B —> A：FIN终止比特=1（ 服务器数据发送完毕请求断开此方向传输 ），seq序号=z，ACK确认比特=1，ack确认号=x+1
4.  A —> B：ACK确认比特=1，seq序号=x+1，ack确认号=z+1

#### 为什么要用四次挥手?

第二次与第三次挥手之间是为了等待服务器发送数据到客户端的发送完毕，因此这两次挥手不能合在一起发送；

#### 为什么第三次挥手需要ack？

假设一种情况，第三次挥手的数据报延迟到达，然后后面又建立一个同端口的TCP连接，然后在处于第二次挥手之后，服务器端还没发送数据完毕，这时延迟的那个第三次挥手数据报到达，关闭连接，导致服务器端没能发送剩余的数据到客户端

#### TCP可靠传输机制

-   传输确认：只要在确认后再继续发送下一个数据段
-   确认号和序列号：ack对应seq+1
-   超时重传
-   固定窗口：限制一次发送的数据段流量
-   滑动窗口：动态的变化窗口的大小，根据缓冲区余量选择窗口大小
-   流量控制：当缓冲区满不能继续接收数据时，设置窗口大小为0，暂停传输

#### TCP的应用

| 端口 | 协议     | 说明      |
| -- | ------ | ------- |
| 21 | FTP    | 文件上传、下载 |
| 23 | Telnet | 远程登录    |
| 25 | SMTP   | 发送邮件    |
| 53 | DNS    | 域名解析    |
| 80 | HTTP   | 超文本传输   |

## UDP

#### UDP的特点

-   运行与OSI模型和TCP/IP模型的传输层
-   为应用程序提供网络层接入而无需为可靠性机制付出多余开销
-   属于无连接协议
-   提供有限的错误检查
-   提供尽力传输
-   不具备数据恢复功能

#### UDP数据报格式

#### 固定首部（8字节）

-   源端口号（ 16bit ）
-   目标端口号（ 16bit ）
-   UDP长度（ 16bit ）
-   UDP校验和（ 16bit ）

#### UDP的应用

| 端口  | 协议   | 说明     |
| --- | ---- | ------ |
| 69  | TFTP | 简单文件传输 |
| 53  | DNS  | 域名服务   |
| 123 | NTP  | 网络时间协议 |
| 111 | RPC  | 远程过程调用 |

\*DNS服务器支持TCP和UDP两种协议的查询方法，大多数都是UDP查询，需要TCP的两种情况：

1.  当查询数据较大以至于产生数据分段，利用TCP分片来进行传输
2.  当主（ master ）服务器和辅（ slave ）服务器之间数据同步通信的时候

## TCP/IP协议栈

| 层次    | 协议                        |
| ----- | ------------------------- |
| 应用层   | FTP、Telnet、SMTP、HTTP、TFTP |
| 传输层   | TCP、UDP                   |
| 网络层   | IP                        |
| 数据链路层 | PPP、Ethernet、Frame Relay  |

根据数据链路类型选择不同的协议，对上层透明（ 就是下层对上层的接口标准统一，无论下层什么协议都通向一个上层 ）（ 数据链路层映射到网络层 ）

根据IP数据报协议号选择应该交给TCP还是UDP （ 网络层映射到传输层 ）

根据端口号提交给相应的应用程序（ 传输层映射到应用层 ）

# 应用层

## DHCP

#### DHCP协议介绍

-   Dynamic Host Configuration Protocol 动态主机配置协议
-   从BOOTP（ Bootstrao Protocol 自举协议 ）发展而来
-   采用C/S模式，客户端向服务器发出配置请求，服务器端根据策略返回相应配置信息
-   采用UDP封装。

#### DHCP协议特点

-   即插即用性：客户端无需配置就能会的IP地址及相关参数
-   统一管理：所有参数由DHCP服务器统一管理、分配
-   使用效率高：通过IP地址租期管理，提高IP使用效率
-   可跨网段：通过DHCP中继，使不同子网的客户端可以与同一个DHCP服务器进行交互

## DNS

#### DNS协议介绍

-   DNS的作用：提供主机名字和IP地址的互相转换
-   采用C/S模式
-   使用传输层TCP或UDP

#### DNS命令

#### windows

-   nslookup：DNS解析
-   ipconfig /flushdns：清除DNS缓存
-   ipconfig /displaydns：显示DNS缓存

#### linux

-   nslookup：DNS解析

#### 域名

例如"[www.baidu.com"，则"baidu.com"为域名，"www"为主机号](http://www.baidu.com"，则"baidu.com"为域名，"www"为主机号)

#### 主机号含义

| 主机号  | 含义      |
| ---- | ------- |
| www  | 网站      |
| blog | 博客      |
| bbs  | 论坛      |
| pop  | 邮件接收服务器 |
| smtp | 邮件发送服务器 |

#### 域名后缀含义

| 域名后缀    | 含义                           |
| ------- | ---------------------------- |
| .com    | 商业机构，任何人都可以注册                |
| .edu    | 教育机构                         |
| .gov    | 政府部门                         |
| .int    | 国际组织                         |
| .mil    | 美国军事部门                       |
| .net    | 网络组织，例如因特网服务商和维修商，现在任何人都可以注册 |
| .org    | 非盈利组织，任何人都可以注册               |
| .biz    | 商业                           |
| .info   | 网络信息服务组织                     |
| .pro    | 用于会计、律师和医生                   |
| .name   | 用于个人                         |
| .museum | 用于博物馆                        |
| .coop   | 用于商业合作团体                     |
| .aero   | 用于航空工业                       |
| .xxx    | 用于成人、色情网站                    |
| .idv    | 用于个人                         |
